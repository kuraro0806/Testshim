# 実機計測
- [実機計測](#実機計測)
  - [はじめに](#はじめに)
    - [実行環境](#実行環境)
  - [実行のための準備](#実行のための準備)
    - [準備](#準備)
    - [実行サイクル取得用のマクロを挿入する](#実行サイクル取得用のマクロを挿入する)
      - [1. `run.sh`を動かす](#1-runshを動かす)
      - [2. `insertMacro/c_src`内に`c_src_Macro`というディレクトリができているのを確認する](#2-insertmacroc_src内にc_src_macroというディレクトリができているのを確認する)
      - [3. `c_src_Macro`内のプログラムをクロスコンパイルする](#3-c_src_macro内のプログラムをクロスコンパイルする)
  - [実機で実行し、実行サイクルを取得する](#実機で実行し実行サイクルを取得する)
    - [注意点](#注意点)
      - [1.PMUの起動](#1pmuの起動)
      - [2.動作周波数の固定](#2動作周波数の固定)
      - [3.結果の出力方法](#3結果の出力方法)

## はじめに

本ディレクトリ実機計測では計測プログラムを実機用にクロスコンパイルし、実行サイクルを取得する機能を提供します。
具体的には以下の通りです。

+ [実行サイクル取得用のマクロを挿入する](#実行サイクル取得用のマクロを挿入する)
+ 実機で実行するためにクロスコンパイル
+ [実機で実行し、実行サイクルを取得する](#実機で実行し、実行サイクルを取得する)

### 実行環境

以下のプラットフォームでの実行を確認しています。

+ 環境
  + Ubuntu ver.16.04LTS
<br>

+ ターゲットハードウェア
  + Raspberry Pi3 Model B+
    + CPU：Cortex-A53
    + OS：Linux ver4.14.68

## 実行のための準備

実行のために計測プログラムにマクロを挿入する流れを説明します。

### 準備

実行するには以下のツールが必要です。

+ Pythonの実行環境
+ ターゲットのハードウェア向けにクロスコンパイルする環境
    + 製作者はコンパイラにaarch64 poky linuxを使用


準備するファイルは以下の通りです。

+ [c_src](../all_c_src/)の計測プログラム
    + c_srcをinsertMacro内に配置する

### 実行サイクル取得用のマクロを挿入する

挿入する手順は以下の通りです。


  1. [run.shを動かす](#1-runshを動かす)
  2. [insertMacro/c_src内にc_src_Macroというディレクトリができているのを確認する](#2-insertmacroc_src内にc_src_macroというディレクトリができているのを確認する)
  3. [c_src_Macroのプログラムをクロスコンパイルする](#3-c_src_macro内のプログラムをクロスコンパイルする)

#### 1. `run.sh`を動かす

動かし方は以下の通りです。
`sudo ./run.sh c_src/*`

#### 2. `insertMacro/c_src`内に`c_src_Macro`というディレクトリができているのを確認する

`c_src`内に`c_src_Macro`ができていて、そのディレクトリの中にマクロが挿入された計測プログラムがあるのを確認してください。

#### 3. `c_src_Macro`内のプログラムをクロスコンパイルする

ターゲットのハードウェアで実行できるようにクロスコンパイルしてください。

## 実機で実行し、実行サイクルを取得する

コンパイルした実行ファイルをUSBメモリ等でターゲットハードウェアに移し、実行してください。

### 注意点
以下の3点に注意して実行してください。

1. [PMUの起動](#1.PMUの起動)
2. [動作周波数の固定](#2.動作周波数の固定)
3. [結果の出力方法](#3.結果の出力方法)

#### 1.PMUの起動

[PMU_module](PMU_module)内の3種類のカーネルモジュール(**.ko)を以下のコマンドでロードしてください。

`insmod (カーネルモジュール)`

#### 2.動作周波数の固定

[PMU_module](PMU_module)内の`cpusetup.sh`を以下のコマンドで動かしてください。

`./cpusetup3.sh`

#### 3.結果の出力方法

実行結果は、以下の例のようにcsvファイルに出力してください。
(BubbleSortは`BubbleSort.c`をコンパイルしたファイル)

`./BubbleSort > res_BubbleSort.csv`